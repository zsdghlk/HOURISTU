<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>日本国憲法｜やさしい解説つき</title>
<style>
  /* ===== 配色（ライト/ダーク自動） ===== */
  :root{
    --fg:#101114; --bg:#ffffff; --muted:#6b7280; --card:#f5f7fa; --accent:#0b57d0;
    --ring:#d0d7de;
  }
  @media (prefers-color-scheme: dark){
    :root{
      --fg:#e7e7ea; --bg:#0f1115; --muted:#9aa0a6; --card:#171a21; --accent:#7aa2ff;
      --ring:#30363d;
    }
  }

  /* ===== ベース ===== */
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; color:var(--fg); background:var(--bg);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    line-height:1.7; -webkit-text-size-adjust:100%;
  }
  a{color:inherit}

  /* ===== レイアウト ===== */
  header{
    position:sticky; top:0; z-index:20; background:var(--bg);
    border-bottom:1px solid var(--ring);
    backdrop-filter:saturate(120%) blur(6px);
  }
  .wrap{max-width:860px; margin:auto; padding:12px 16px}
  .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}

  /* ===== フォーム/ボタン ===== */
  input,select,button{
    font:inherit; padding:12px 14px; border:1px solid var(--ring); border-radius:12px;
    background:transparent; color:var(--fg); min-height:44px;
  }
  input[type="search"]{flex:1; min-width:180px}
  button{cursor:pointer}
  .modebtns button[aria-pressed="true"]{background:var(--accent); color:#fff; border-color:transparent}
  .badge{font-size:12px; color:var(--muted)}

  /* ===== 本文カード ===== */
  .chapter{margin:18px 0}
  .chapter h2{margin:10px 0 6px; font-size:18px}
  .article{
    padding:14px; border-radius:14px; background:var(--card); margin:12px 0; border:1px solid var(--ring);
  }
  .art-head{display:flex; justify-content:space-between; gap:8px; align-items:center}
  .art-no{font-weight:700}
  .block{margin:10px 0; padding:12px; border-radius:12px; background:#00000008}
  .block.original{border-left:4px solid #9ca3af}
  .block.easy{border-left:4px solid var(--accent)}
  .muted{color:var(--muted); font-size:14px}
  .toc{display:flex; flex-wrap:wrap; gap:6px; margin:8px 0}
  .toc a{padding:6px 10px; border:1px solid var(--ring); border-radius:999px; text-decoration:none}

  /* ===== 小画面最適化 ===== */
  @media (max-width: 640px){
    .wrap{padding:12px}
    h1,strong{font-size:18px}
    .chapter h2{font-size:16px}
    .article{padding:12px}
    input[type="search"]{min-width:120px}
  }

  /* ===== 動きを控えめに ===== */
  @media (prefers-reduced-motion: reduce){
    *{scroll-behavior:auto; animation:none; transition:none}
  }
</style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="row">
      <strong>日本国憲法（原文／やさしい文）</strong>
      <span class="badge" id="meta"></span>
    </div>
    <div class="row" style="margin-top:6px">
      <div class="modebtns" role="group" aria-label="表示切替">
        <button id="m-easy"   aria-pressed="true">やさしい文</button>
        <button id="m-both"   aria-pressed="false">両方</button>
        <button id="m-orig"   aria-pressed="false">原文のみ</button>
      </div>
      <input id="q" type="search" placeholder="検索（原文・やさしい文・条番号）" autocomplete="off" enterkeyhint="search">
      <select id="goto" aria-label="条番号へ移動"></select>
      <button id="go">移動</button>
    </div>
  </div>
</header>

<main class="wrap" id="app">
  <p class="muted">読み込み中…</p>
</main>

<div class="wrap" style="color:var(--muted); font-size:12px; margin:32px 0">
  データ出典：e-Gov法令検索（原文）。やさしい文は学習目的の言い換えです（意味は原文と同一を目指しています）。
</div>

<script>
const state = { mode: 'easy', data: null, flat: [] };

/* ===== UI: モード切替 ===== */
const setMode = (m)=>{
  state.mode = m;
  for (const id of ['m-easy','m-both','m-orig']){
    document.getElementById(id).setAttribute('aria-pressed', id==='m-'+m ? 'true':'false');
  }
  render();
};
document.getElementById('m-easy').onclick = ()=>setMode('easy');
document.getElementById('m-both').onclick = ()=>setMode('both');
document.getElementById('m-orig').onclick = ()=>setMode('orig');

/* ===== UI: ジャンプ ===== */
document.getElementById('go').onclick = ()=>{
  const val = document.getElementById('goto').value;
  if (val){ location.hash = encodeURIComponent(val); }
};

/* ===== UI: 検索 ===== */
document.getElementById('q').addEventListener('input', (e)=> render(e.target.value.trim()));

/* ===== データ読み込み ===== */
async function load(){
  try{
    const res = await fetch('./data/kenpo.json',{cache:'no-store'});
    if(!res.ok) throw new Error(`HTTP ${res.status} ${res.statusText}`);
    const raw = await res.json();

    // ▼ 形の揺れを正規化
    state.data = normalizeLawData(raw);

    // ▼ メタ表示（undefined防止）
    document.getElementById('meta').textContent =
      `${state.data.law || '日本国憲法'} / 更新: ${state.data.version || '-'}`;

    // ▼ 目次（章＋条番号）
    state.flat = [];
    for (const ch of state.data.chapters){
      for (const a of ch.articles){
        state.flat.push({ chapter: ch.title, no: a.no });
      }
    }
    const sel = document.getElementById('goto');
    sel.innerHTML = '<option value="">条番号へ移動</option>' +
      state.flat.map(x=>`<option value="${x.no}">${x.no}（${x.chapter}）</option>`).join('');

    render();

    // ハッシュがあればスクロール
    if (location.hash) {
      const id = decodeURIComponent(location.hash.slice(1));
      const el = document.getElementById(id);
      if (el) el.scrollIntoView({behavior:'smooth', block:'start'});
    }
  }catch(e){
    console.error(e);
    document.getElementById('app').innerHTML = `<p style="color:#c00">読み込みエラー: ${escapeHtml(e.message)}</p>`;
  }
}

/* ===== データ正規化 =====
  期待形:
  {
    law, version,
    chapters: [{ title, articles:[{ no, original, easy }] }]
  }
*/
function normalizeLawData(data){
  // 1) 行配列（旧形）に対応
  //   例: [{ chapter, article/num/no, text/original, easy/textEasy }, ...]
  if (Array.isArray(data)) {
    const map = new Map();
    for (const row of data){
      const chTitle = row.chapter ?? row.title ?? '（章）';
      const art = {
        no: row.no ?? row.num ?? row.article ?? '',
        original: row.original ?? row.text ?? '',
        easy: row.easy ?? row.textEasy ?? ''
      };
      if (!map.has(chTitle)) map.set(chTitle, []);
      map.get(chTitle).push(art);
    }
    return {
      law: '日本国憲法',
      version: '',
      chapters: Array.from(map, ([title, articles]) => ({ title, articles }))
    };
  }

  // 2) オブジェクト（chaptersあり）
  if (data && Array.isArray(data.chapters)){
    const law   = data.law ?? data.lawName ?? data.lawId ?? '日本国憲法';
    const ver   = data.version ?? data.update ?? '';
    const chs = data.chapters.map(ch => {
      const title = ch.title ?? ch.chapter ?? '（章）';
      const arts = (ch.articles ?? []).map(a => ({
        no: a.no ?? a.num ?? a.article ?? '',
        original: a.original ?? a.text ?? '',
        easy: a.easy ?? a.textEasy ?? ''
      }));
      return { title, articles: arts };
    });
    return { law, version: ver, chapters: chs };
  }

  // 3) 想定外 → 空
  return { law: '日本国憲法', version: '', chapters: [] };
}

/* ===== 検索マッチ ===== */
function matches(a, q){
  if (!q) return true;
  q = q.toLowerCase();
  return (String(a.no) + ' ' + String(a.original) + ' ' + String(a.easy)).toLowerCase().includes(q);
}

/* ===== 描画 ===== */
function render(q=''){
  const app = document.getElementById('app');
  if (!state.data){ app.innerHTML = '<p>読み込み中…</p>'; return; }

  const parts = [];
  for (const ch of state.data.chapters){
    const visArts = ch.articles.filter(a => matches(a, q));
    if (visArts.length===0) continue;

    parts.push(`<section class="chapter">
      <h2>${escapeHtml(ch.title)}</h2>
      <div class="toc">
        ${ch.articles.map(a=>`<a href="#${encodeURIComponent(a.no)}">${escapeHtml(a.no)}</a>`).join('')}
      </div>
    `);

    for (const a of visArts){
      const id = encodeURIComponent(a.no);
      const head = `
        <div class="art-head">
          <div class="art-no" id="${id}">${escapeHtml(a.no)}</div>
          <a class="muted" href="#${id}" title="リンク">#</a>
        </div>`;

      let body = '';
      if (state.mode==='easy'){
        body = `<div class="block easy"><div>${escapeHtml(a.easy || '（やさしい日本語の準備中）')}</div></div>`;
      } else if (state.mode==='orig'){
        body = `<div class="block original"><div>${escapeHtml(a.original || '')}</div></div>`;
      } else {
        body = `
          <div class="block easy"><strong>やさしい文</strong><div>${escapeHtml(a.easy || '（やさしい日本語の準備中）')}</div></div>
          <div class="block original"><strong>原文</strong><div>${escapeHtml(a.original || '')}</div></div>`;
      }

      parts.push(`<article class="article">${head}${body}</article>`);
    }
    parts.push(`</section>`);
  }
  app.innerHTML = parts.join('') || `<p>該当なし（検索ワードを変えてください）</p>`;
}

/* ===== HTMLエスケープ（修正版） ===== */
function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, m => ({
    '&':'&amp;',
    '<':'&lt;',
    '>':'&gt;',
    '"':'&quot;',
    "'":'&#39;'
  }[m]));
}

/* 起動 */
load();
</script>
</body>
</html>
