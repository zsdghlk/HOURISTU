import { fetchLawJson, toArray } from "@/lib/egov";

/** ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ï¼šãƒ†ã‚­ã‚¹ãƒˆæŠ½å‡º */
function textOf(x: any): string {

/** LawTitle / LawName ã‚’é ‘ä¸ˆã«è§£æ±º */
function resolveTitle(law: any, fallbackId: string): string {
  const cands = [
    textOf(law?.LawTitle?._),
    textOf(law?.LawTitle),
    textOf(law?.LawName),
    textOf(law?.LawBody?.LawTitle?._),
    textOf(law?.LawBody?.LawTitle),
  ];
  const t = cands.find((s) => s && s.trim().length > 0);
  return t || `ï¼ˆæ³•ä»¤åä¸æ˜ï¼š${fallbackId}ï¼‰`;
}

  if (!x) return "";

/** LawTitle / LawName ã‚’é ‘ä¸ˆã«è§£æ±º */
function resolveTitle(law: any, fallbackId: string): string {
  const cands = [
    textOf(law?.LawTitle?._),
    textOf(law?.LawTitle),
    textOf(law?.LawName),
    textOf(law?.LawBody?.LawTitle?._),
    textOf(law?.LawBody?.LawTitle),
  ];
  const t = cands.find((s) => s && s.trim().length > 0);
  return t || `ï¼ˆæ³•ä»¤åä¸æ˜ï¼š${fallbackId}ï¼‰`;
}

  if (typeof x === "string") return x;

/** LawTitle / LawName ã‚’é ‘ä¸ˆã«è§£æ±º */
function resolveTitle(law: any, fallbackId: string): string {
  const cands = [
    textOf(law?.LawTitle?._),
    textOf(law?.LawTitle),
    textOf(law?.LawName),
    textOf(law?.LawBody?.LawTitle?._),
    textOf(law?.LawBody?.LawTitle),
  ];
  const t = cands.find((s) => s && s.trim().length > 0);
  return t || `ï¼ˆæ³•ä»¤åä¸æ˜ï¼š${fallbackId}ï¼‰`;
}

  if (typeof x === "number") return String(x);

/** LawTitle / LawName ã‚’é ‘ä¸ˆã«è§£æ±º */
function resolveTitle(law: any, fallbackId: string): string {
  const cands = [
    textOf(law?.LawTitle?._),
    textOf(law?.LawTitle),
    textOf(law?.LawName),
    textOf(law?.LawBody?.LawTitle?._),
    textOf(law?.LawBody?.LawTitle),
  ];
  const t = cands.find((s) => s && s.trim().length > 0);
  return t || `ï¼ˆæ³•ä»¤åä¸æ˜ï¼š${fallbackId}ï¼‰`;
}

  if (x._ && typeof x._ === "string") return x._;

/** LawTitle / LawName ã‚’é ‘ä¸ˆã«è§£æ±º */
function resolveTitle(law: any, fallbackId: string): string {
  const cands = [
    textOf(law?.LawTitle?._),
    textOf(law?.LawTitle),
    textOf(law?.LawName),
    textOf(law?.LawBody?.LawTitle?._),
    textOf(law?.LawBody?.LawTitle),
  ];
  const t = cands.find((s) => s && s.trim().length > 0);
  return t || `ï¼ˆæ³•ä»¤åä¸æ˜ï¼š${fallbackId}ï¼‰`;
}

  return "";

/** LawTitle / LawName ã‚’é ‘ä¸ˆã«è§£æ±º */
function resolveTitle(law: any, fallbackId: string): string {
  const cands = [
    textOf(law?.LawTitle?._),
    textOf(law?.LawTitle),
    textOf(law?.LawName),
    textOf(law?.LawBody?.LawTitle?._),
    textOf(law?.LawBody?.LawTitle),
  ];
  const t = cands.find((s) => s && s.trim().length > 0);
  return t || `ï¼ˆæ³•ä»¤åä¸æ˜ï¼š${fallbackId}ï¼‰`;
}

}

/** LawTitle / LawName ã‚’é ‘ä¸ˆã«è§£æ±º */
function resolveTitle(law: any, fallbackId: string): string {
  const cands = [
    textOf(law?.LawTitle?._),
    textOf(law?.LawTitle),
    textOf(law?.LawName),
    textOf(law?.LawBody?.LawTitle?._),
    textOf(law?.LawBody?.LawTitle),
  ];
  const t = cands.find((s) => s && s.trim().length > 0);
  return t || `ï¼ˆæ³•ä»¤åä¸æ˜ï¼š${fallbackId}ï¼‰`;
}


/** 8æ¡ YYYYMMDD ã‚’ "YYYYå¹´MMæœˆDDæ—¥" ã«ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆå¤±æ•—æ™‚ã¯åŸæ–‡ã‚’è¿”ã™ï¼‰ */
function formatYmd(s: string): string {
  const m = /^(\d{4})(\d{2})(\d{2})$/.exec(s);
  if (!m) return s;
  return `${m[1]}å¹´${m[2].replace(/^0/,"") }æœˆ${m[3].replace(/^0/,"")}æ—¥`;
}

/** Article ã‚’æœ¨æ§‹é€ ã‹ã‚‰åé›†ï¼ˆArticleã®ã¿ã‚’æ·±æ˜ã‚Šï¼‰ */
function collectArticles(node: any): any[] {
  if (!node || typeof node !== "object") return [];
  let out: any[] = [];
  if ((node as any).Article) out = out.concat(toArray((node as any).Article));
  for (const k of Object.keys(node)) {
    const v = (node as any)[k];
    if (v && typeof v === "object") {
      const arr = Array.isArray(v) ? v : [v];
      for (const c of arr) out = out.concat(collectArticles(c));
    }
  }
  return out;
}

/** Sentence ç³»ã‚’ã¾ã¨ã‚ã¦æ–‡å­—åˆ—åŒ– */
function collectSentences(node: any): string[] {
  if (!node) return [];
  if (typeof node === "string") return [node];
  if (typeof node === "object") {
    const out: string[] = [];
    if ((node as any).Sentence) {
      for (const s of toArray((node as any).Sentence)) out.push(...collectSentences(s));
    }
    if ((node as any).ParagraphSentence) {
      for (const s of toArray((node as any).ParagraphSentence)) out.push(...collectSentences(s));
    }
    if ((node as any)._ && typeof (node as any)._ === "string") out.push((node as any)._);
    return out;
  }
  return [];
}

/** æ®µè½ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚° */
function renderParagraph(p: any): string {
  const num =
    (typeof p?.ParagraphNum === "string" ? p.ParagraphNum : p?.ParagraphNum?._) ||
    (typeof p?.Num === "string" ? p.Num : p?.Num?._) || "";
  const text = collectSentences(p?.ParagraphSentence ?? p?.Sentence ?? p).join("");
  return `<p>${num ? `<span class="mr-2">${num}</span>` : ""}${text}</p>`;
}

/** æ¡ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ï¼ˆæ¡ç•ªå· â†’ è¦‹å‡ºã— â†’ æœ¬æ–‡ï¼‰ */
function renderArticlePlain(a: any, fallbackKey: string): string {
  const ttl =
    (typeof a?.ArticleTitle === "string" ? a.ArticleTitle : a?.ArticleTitle?._) ||
    (typeof a?.$?.Num === "string" ? a.$.Num : "") || fallbackKey;

  const cap =
    (typeof a?.ArticleCaption === "string" ? a.ArticleCaption : a?.ArticleCaption?._) || "";

  const paragraphs = toArray(a?.Paragraph);
  const bodyHtml = paragraphs.map(renderParagraph).join("");

  const heading =
    `<h3 class="text-lg font-semibold mt-8 mb-2">` +
    `${ttl}${cap ? `ã€€${cap}` : ""}` +
    `</h3>`;
  return heading + bodyHtml;
}

/** Articleç•ªå·ï¼ˆNumï¼‰ã‚’å–å¾—ï¼ˆãªã‘ã‚Œã°ç©ºï¼‰ */
function getArticleNum(a: any): string {
  const n = a?.$?.Num ?? a?.Num ?? (typeof a?.ArticleTitle === "string" ? a.ArticleTitle : a?.ArticleTitle?._);
  return typeof n === "string" ? n : "";
}

/** ã‚°ãƒ«ãƒ¼ãƒ—è¦‹å‡ºã—ï¼ˆã‚¤ãƒ³ãƒ©ã‚¤ãƒ³CSSã§ç¢ºå®Ÿã«å¼·èª¿ï¼‰ */
function groupBadge(label: "é™„å‰‡" | "æ”¹æ­£çµŒé", n: number, meta?: string): string {
  const base = `
    display:inline-block;
    font-weight:700;
    font-size:0.95rem;
    line-height:1.4;
    padding:2px 10px;
    border-radius:6px;
    border:1px solid rgba(0,0,0,0.12);
    margin-right:.5rem;
  `;
  const colors =
    label === "é™„å‰‡"
      ? "color:#065f46;background:#d1fae5;border-color:#34d399;"   /* ç·‘ç³» */
      : "color:#3730a3;background:#e0e7ff;border-color:#818cf8;"; /* ç´«ç³» */
  const metaSpan = meta
    ? `<span style="font-size:.85rem;color:#374151;">${meta}</span>`
    : "";
  return `
    <div style="margin-top:3rem;margin-bottom:1rem;border-top:1px dashed rgba(0,0,0,0.25);padding-top:0.75rem;">
      <span style="${base}${colors}">ï¼ˆ${label} ç¬¬${n}ç¾¤ï¼‰</span>${metaSpan}
    </div>`;
}

/** é™„å‰‡ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼šæ¡ç•ªå·ãŒ 1 ã«æˆ»ã£ãŸã‚‰ã‚°ãƒ«ãƒ¼ãƒ—åˆ‡æ›¿ï¼ˆãƒ¡ã‚¿ã¯åŸºæœ¬ç„¡ã—ï¼‰ */
function renderSupplGrouped(root: any): string {
  const arts = collectArticles(root);
  if (!arts.length) return "";
  let html = "";
  let group = 0;
  let lastNum = "";

  for (let i = 0; i < arts.length; i++) {
    const a = arts[i];
    const num = getArticleNum(a);
    if (i === 0 || (num === "1" && lastNum && lastNum !== "1")) {
      group += 1;
      html += groupBadge("é™„å‰‡", group);  // é™„å‰‡ã¯ãƒ¡ã‚¿ãŒå–ã‚Šã«ãã„ã®ã§ç•ªå·ã®ã¿
    }
    html += renderArticlePlain(a, String(i + 1));
    lastNum = num || lastNum;
  }
  return html;
}

/** æ”¹æ­£çµŒéã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼šAmendLaw å˜ä½ã§ç¢ºå®Ÿã«ã‚°ãƒ«ãƒ¼ãƒ”ãƒ³ã‚°ã—ã€ãƒ¡ã‚¿ï¼ˆæ³•å¾‹ç•ªå·ãƒ»å…¬å¸ƒæ—¥ï¼‰ã‚’è¡¨ç¤º */
function renderAmendGrouped(root: any): string {
  if (!root) return "";
  const amendLaws = toArray((root as any)?.AmendLaw);
  // AmendLaw ãŒã‚ã‚‹å ´åˆã¯ãã‚Œã‚’ã‚°ãƒ«ãƒ¼ãƒ—å˜ä½ã¨ã—ã¦æ‰±ã†
  if (amendLaws.length > 0) {
    let html = "";
    amendLaws.forEach((lawNode: any, idx: number) => {
      // ãƒ¡ã‚¿æƒ…å ±ã®æŠ½å‡ºï¼ˆã‚ˆãã‚ã‚‹ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ã‚±ã‚¢ï¼‰
      const lawNum =
        textOf(lawNode?.LawNum) ||
        textOf(lawNode?.$?.LawNum) ||
        textOf(root?.LawNum) || "";

      const promRaw =
        textOf(lawNode?.PromulgationDate) ||
        textOf(lawNode?.Promulgation) ||
        textOf(lawNode?.$?.PromulgationDate) || "";

      const prom = promRaw ? formatYmd(promRaw) : "";
      const title = resolveTitle(law, lawId);

      // ãƒ¡ã‚¿è¡Œã®æ–‡è¨€ã‚’ä½œæˆ
      const metaParts = [];
      if (title) metaParts.push(title);
      if (lawNum) metaParts.push(`æ³•å¾‹ç•ªå·ï¼š${lawNum}`);
      if (prom) metaParts.push(`å…¬å¸ƒï¼š${prom}`);
      const meta = metaParts.join("ã€€");

      html += groupBadge("æ”¹æ­£çµŒé", idx + 1, meta || undefined);

      // ã“ã® AmendLaw ã® Article ã‚’æç”»
      const arts = collectArticles(lawNode);
      if (arts.length) {
        html += arts.map((a: any, i: number) => renderArticlePlain(a, String(i + 1))).join("");
      } else {
        // å¿µã®ãŸã‚ã€Article ãŒç„¡ã„ç‰¹æ®Šã‚±ãƒ¼ã‚¹ã§ã‚‚ãƒ¡ã‚¿ã ã‘ã¯æ®‹ã™
        html += `<p style="color:#6b7280;">ï¼ˆæ¡æ–‡ãªã—ï¼‰</p>`;
      }
    });
    return html;
  }

  // AmendLaw ãŒç„¡ã„å ´åˆã¯ã€å¾“æ¥ã©ãŠã‚Šã€Œæ¡ç•ªå·1ãƒªã‚»ãƒƒãƒˆã€ã‚’ãƒˆãƒªã‚¬ã«ã‚°ãƒ«ãƒ¼ãƒ”ãƒ³ã‚°
  const arts = collectArticles(root);
  if (!arts.length) return "";
  let html = "";
  let group = 0;
  let lastNum = "";
  for (let i = 0; i < arts.length; i++) {
    const a = arts[i];
    const num = getArticleNum(a);
    if (i === 0 || (num === "1" && lastNum && lastNum !== "1")) {
      group += 1;
      html += groupBadge("æ”¹æ­£çµŒé", group);
    }
    html += renderArticlePlain(a, String(i + 1));
    lastNum = num || lastNum;
  }
  return html;
}

export default async function LawPage(props: { params: Promise<{ lawId: string }> }) {
  const { lawId } = await props.params;
  const law = await fetchLawJson(lawId);
  const body = law?.LawBody ?? {};

  const title = resolveTitle(law, lawId);
    (typeof law?.LawTitle === "string" ? law?.LawTitle : law?.LawTitle?._) ||
    law?.LawName || "ï¼ˆç„¡é¡Œã®æ³•ä»¤ï¼‰";

  /** æ–½è¡Œæ—¥æƒ…å ±ï¼ˆEnactStatement ã¯ã‚¿ã‚¤ãƒˆãƒ«ç›´ä¸‹ ï¼ å°ã•ã‚è¡¨ç¤ºï¼‰ */
  const enactHtml = toArray(law?.EnactStatement)
    .map((x: any) => (typeof x === "string" ? x : (x?._ ?? "")))
    .filter(Boolean)
    .map((t) => `<p>${t}</p>`)
    .join("");

  /** æœ¬æ–‡ï¼ˆMainProvisioné…ä¸‹ Articleã®ã¿ï¼‰ */
  const mainArticles = collectArticles(body?.MainProvision);
  const mainHtml = mainArticles.map((a: any, i: number) => renderArticlePlain(a, String(i + 1))).join("");

  /** é™„å‰‡ãƒ»æ”¹æ­£ï¼ˆã‚°ãƒ«ãƒ¼ãƒ—è¦‹å‡ºã—ã‚’è‡ªå‹•æŒ¿å…¥ã€‚æ”¹æ­£ã¯ãƒ¡ã‚¿ã‚’ä»˜ã‘ã‚‹ï¼‰ */
  const supplHtml = renderSupplGrouped(body?.SupplProvision);
  const amendHtml = renderAmendGrouped(body?.AmendProvision);

  /** æ”¹æ­£å¹´æœˆæ—¥ï¼ˆå¿…è¦ãŒã‚ã‚Œã°ã“ã“ã«æŠ½å‡ºã‚’è¿½åŠ ï¼‰ */
  const amendDates = (() => {
    const info = (body as any)?.AmendProvision?.AmendLawInfo;
    if (!info) return "";
    const txt = collectSentences(info).join("") ||
      toArray(info).map((x: any) => (typeof x === "string" ? x : (x?._ ?? ""))).join("");
    return txt ? `<p>${txt}</p>` : "";
  })();

  /** ãƒšãƒ¼ã‚¸ä¸Šéƒ¨ã®èª¬æ˜ï¼ˆæœ¬æ–‡ãƒ»é™„å‰‡ãƒ»æ”¹æ­£çµŒéã®é•ã„ï¼‰ */
  const hasSuppl = !!body?.SupplProvision; 
  const hasAmend = !!body?.AmendProvision; 
  const aboutLines: string[] = [
    `<p class="mb-2"><span class="font-bold text-blue-700 dark:text-blue-300">ğŸ“– æœ¬æ–‡</span> â€¦â€¦ æ³•å¾‹ã®æœ¬ä½“éƒ¨åˆ†ï¼ˆç¬¬1æ¡ã€œæœ€çµ‚æ¡ï¼‰ã€‚</p>`
  ];
  if (hasSuppl) {
    aboutLines.push(`<p class="mb-2"><span class="font-bold text-green-700 dark:text-green-300">ğŸ“Œ é™„å‰‡</span> â€¦â€¦ åˆ¶å®šã‚„æ”¹æ­£ã«ä¼´ã†æ–½è¡ŒæœŸæ—¥ãƒ»çµŒéæªç½®ãƒ»ç‰¹ä¾‹ãªã©ã‚’ã¾ã¨ã‚ãŸéƒ¨åˆ†ã€‚æ”¹æ­£ã®ãŸã³ã«æ–°ã—ã„é™„å‰‡ãŒè¿½åŠ ã•ã‚Œã‚‹ãŸã‚ã€é™„å‰‡å†…ã§ã‚‚ã€Œç¬¬ä¸€æ¡ã€ã‹ã‚‰ç•ªå·ãŒå†é–‹ã™ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚</p>`);
  }
  if (hasAmend) {
    aboutLines.push(`<p class="mb-0"><span class="font-bold text-purple-700 dark:text-purple-300">ğŸ“ æ”¹æ­£çµŒé</span> â€¦â€¦ æ­´ä»£ã®æ”¹æ­£æ³•ã«é–¢ã™ã‚‹é™„å‰‡ãªã©ã‚’æ™‚ç³»åˆ—ã§ã¾ã¨ã‚ãŸé ˜åŸŸã§ã™ã€‚ã“ã®ã‚µã‚¤ãƒˆã§ã¯ã€æ”¹æ­£æ³•ã”ã¨ã«<strong>æ³•å¾‹ç•ªå·ãƒ»å…¬å¸ƒå¹´æœˆæ—¥</strong>ç­‰ã®ãƒ¡ã‚¿æƒ…å ±ã‚’ã‚°ãƒ«ãƒ¼ãƒ—è¦‹å‡ºã—ã¨ã—ã¦è¡¨ç¤ºã—ã¾ã™ã€‚</p>`);
  }
}
