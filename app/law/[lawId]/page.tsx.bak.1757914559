import { fetchLawJson, toArray } from "@/lib/egov";

/** Article ã‚’æœ¨æ§‹é€ ã‹ã‚‰åé›† */
function collectArticles(node: any): any[] {
  if (!node || typeof node !== "object") return [];
  let out: any[] = [];
  if ((node as any).Article) out = out.concat(toArray((node as any).Article));
  for (const k of Object.keys(node)) {
    const v = (node as any)[k];
    if (v && typeof v === "object") {
      const arr = Array.isArray(v) ? v : [v];
      for (const c of arr) out = out.concat(collectArticles(c));
    }
  }
  return out;
}

/** Sentence ç³»ã‚’ã¾ã¨ã‚ã¦æ–‡å­—åˆ—åŒ– */
function collectSentences(node: any): string[] {
  if (!node) return [];
  if (typeof node === "string") return [node];
  if (typeof node === "object") {
    const out: string[] = [];
    if ((node as any).Sentence) {
      for (const s of toArray((node as any).Sentence)) out.push(...collectSentences(s));
    }
    if ((node as any).ParagraphSentence) {
      for (const s of toArray((node as any).ParagraphSentence)) out.push(...collectSentences(s));
    }
    if ((node as any)._ && typeof (node as any)._ === "string") out.push((node as any)._);
    return out;
  }
  return [];
}

/** æ®µè½ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚° */
function renderParagraph(p: any): string {
  const num =
    (typeof p?.ParagraphNum === "string" ? p.ParagraphNum : p?.ParagraphNum?._) ||
    (typeof p?.Num === "string" ? p.Num : p?.Num?._) || "";
  const text = collectSentences(p?.ParagraphSentence ?? p?.Sentence ?? p).join("");
  return `<p>${num ? `<span class="mr-2">${num}</span>` : ""}${text}</p>`;
}

/** æ¡ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ï¼ˆæ¡ç•ªå· â†’ è¦‹å‡ºã— â†’ æœ¬æ–‡ï¼‰ */
function renderArticlePlain(a: any, fallbackKey: string): string {
  const ttl =
    (typeof a?.ArticleTitle === "string" ? a.ArticleTitle : a?.ArticleTitle?._) ||
    (typeof a?.$?.Num === "string" ? a.$.Num : "") || fallbackKey;

  const cap =
    (typeof a?.ArticleCaption === "string" ? a.ArticleCaption : a?.ArticleCaption?._) || "";

  const paragraphs = toArray(a?.Paragraph);
  const bodyHtml = paragraphs.map(renderParagraph).join("");

  // å·¦å³å…¥ã‚Œæ›¿ãˆï¼ˆæ¡ç•ªå· â†’ è¦‹å‡ºã—ï¼‰
  const heading =
    `<h3 class="text-lg font-semibold mt-8 mb-2">` +
    `${ttl}${cap ? `ã€€${cap}` : ""}` +
    `</h3>`;
  return heading + bodyHtml;
}

export default async function LawPage(props: { params: Promise<{ lawId: string }> }) {
  const { lawId } = await props.params;
  const law = await fetchLawJson(lawId);
  const body = law?.LawBody ?? {};

  // ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆLawTitle/LawName ã®ä¸¡æ–¹ã‚’é ‘ä¸ˆã«è§£æ±ºï¼‰
  const title =
    (typeof law?.LawTitle === "string" ? law?.LawTitle : (law?.LawTitle?._ ?? "")) ||
    (typeof law?.LawName === "string" ? law.LawName : (law?.LawName?._ ?? "")) ||
    "ï¼ˆç„¡é¡Œã®æ³•ä»¤ï¼‰";

  // æœ¬æ–‡
  const mainArticles = collectArticles(body?.MainProvision);
  const mainHtml = mainArticles.map((a, i) => renderArticlePlain(a, String(i + 1))).join("");

  // é™„å‰‡
  const supplArticles = collectArticles(body?.SupplProvision);
  const supplHtml = supplArticles.map((a, i) => renderArticlePlain(a, `é™„å‰‡${i + 1}`)).join("");

  // èª¬æ˜ãƒœãƒƒã‚¯ã‚¹ï¼šé™„å‰‡ or æ”¹æ­£çµŒéãŒã‚ã‚‹ã¨ãã ã‘å‡ºã™
  const hasSuppl = !!body?.SupplProvision;
  const hasAmend = !!body?.AmendProvision; // å°†æ¥ç”¨
  const aboutHtml =
    hasSuppl || hasAmend
      ? `<div id="about-law-sections" class="mb-6 rounded-lg border-l-4 border-blue-500 bg-blue-50 dark:bg-blue-900/30 p-4 text-sm leading-relaxed">
           <p class="mb-2"><span class="font-bold text-blue-700 dark:text-blue-300">ğŸ“– æœ¬æ–‡</span> â€¦â€¦ æ³•å¾‹ã®æœ¬ä½“éƒ¨åˆ†ï¼ˆç¬¬1æ¡ã€œæœ€çµ‚æ¡ï¼‰ã€‚</p>
           ${hasSuppl ? `<p class="mb-0"><span class="font-bold text-green-700 dark:text-green-300">ğŸ“Œ é™„å‰‡</span> â€¦â€¦ æ–½è¡ŒæœŸæ—¥ãƒ»çµŒéæªç½®ãƒ»ç‰¹ä¾‹ãªã©ã€‚æ”¹æ­£ã®ãŸã³ã«é™„å‰‡ãŒè¿½åŠ ã•ã‚Œã€é™„å‰‡å†…ã§ã‚‚ã€Œç¬¬ä¸€æ¡ã€ã‹ã‚‰ç•ªå·ãŒå†é–‹ã™ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚</p>` : ``}
         </div>`
      : "";

  return (
    <main className="mx-auto max-w-3xl p-6">
      <h1 className="text-2xl font-bold mb-6">{title}</h1>

      {/* èª¬æ˜ãƒœãƒƒã‚¯ã‚¹ï¼ˆæ¡ä»¶ä»˜ãï¼‰ */}
      <div dangerouslySetInnerHTML={{ __html: aboutHtml }} />

      {/* æœ¬æ–‡ */}
      <article className="prose dark:prose-invert max-w-none">
        <div dangerouslySetInnerHTML={{ __html: mainHtml }} />
      </article>

      {/* é™„å‰‡ï¼ˆæ¡ä»¶ä»˜ãï¼‰ */}
      {supplHtml && (
        <section className="mt-10 text-sm">
          <h2 className="text-lg font-semibold mb-2">é™„å‰‡</h2>
          <div className="prose dark:prose-invert max-w-none" dangerouslySetInnerHTML={{ __html: supplHtml }} />
        </section>
      )}
    </main>
  );
}
