<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Repo Tree Viewer</title>
<style>
  :root { --fg:#111; --muted:#666; --bg:#fff; --line:#ddd; --accent:#0b5fff; }
  @media (prefers-color-scheme: dark) {
    :root { --fg:#eee; --muted:#aaa; --bg:#0b0f17; --line:#2a2f3a; --accent:#6aa3ff; }
  }
  html,body{margin:0;padding:0;background:var(--bg);color:var(--fg);font:14px/1.5 system-ui,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans JP","Hiragino Kaku Gothic ProN","Yu Gothic",sans-serif}
  header{position:sticky;top:0;background:var(--bg);border-bottom:1px solid var(--line);padding:10px 12px;z-index:5}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  input[type="search"]{flex:1;min-width:220px;padding:8px 10px;border:1px solid var(--line);border-radius:10px;background:transparent;color:var(--fg)}
  .btn{border:1px solid var(--line);padding:8px 10px;border-radius:10px;background:transparent;color:var(--fg);cursor:pointer}
  .btn:hover{border-color:var(--accent)}
  main{padding:12px;display:grid;grid-template-columns:1fr 360px;gap:16px}
  @media (max-width: 980px){ main{grid-template-columns:1fr} #panel{order:-1} }
  .stats{color:var(--muted);font-size:12px}
  .tree{margin:10px 0 40px 0}
  .tree ul{list-style:none;padding-left:20px;border-left:1px dashed var(--line)}
  .tree li{margin:2px 0;white-space:nowrap;cursor:default}
  .node{display:flex;align-items:center;gap:6px}
  .label{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
  .dir>.label{font-weight:600}
  .file .ext{color:var(--muted);font-size:12px}
  details{margin:2px 0}
  details>summary{list-style:none;cursor:pointer}
  summary::-webkit-details-marker{display:none}
  .hit{background:rgba(11,95,255,0.10);border-radius:6px}
  .muted{color:var(--muted)}
  #panel{border:1px solid var(--line);border-radius:12px;padding:12px}
  #panel h3{margin:0 0 8px 0;font-size:16px}
  #panel .kv{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;font-size:12px}
  #panel .role{display:inline-block;padding:2px 8px;border:1px solid var(--line);border-radius:20px;margin:4px 0}
  #panel .desc{margin:8px 0;color:var(--muted)}
  .clickable{cursor:pointer}
  .selected{outline:2px solid var(--accent);border-radius:6px}
</style>
</head>
<body>
<header>
  <div class="row">
    <input id="q" type="search" placeholder="フィルタ（例: app/law, *.tsx, api）" />
    <button id="expand" class="btn">すべて展開</button>
    <button id="collapse" class="btn">すべて折りたたみ</button>
    <span id="stats" class="stats"></span>
  </div>
</header>
<main>
  <section>
    <div id="rootName" class="muted"></div>
    <div id="tree" class="tree"></div>
  </section>
  <aside id="panel">
    <h3>ファイル情報</h3>
    <div id="p_name" class="kv">選択してください</div>
    <div id="p_role" class="role"></div>
    <div id="p_desc" class="desc"></div>
    <div class="kv"><b>Path:</b> <span id="p_path"></span></div>
    <div class="kv"><b>Type:</b> <span id="p_type"></span></div>
    <div class="kv"><b>Ext:</b> <span id="p_ext"></span></div>
  </aside>
</main>
<script>
  const DATA = {"name": "HOURISTU", "type": "dir", "children": [{"name": "api", "type": "dir", "children": [{"name": "law", "type": "dir", "children": [{"name": "[lawId]", "type": "dir", "children": [{"name": "article", "type": "dir", "children": []}, {"name": "loading.tsx", "type": "file"}, {"name": "page.tsx", "type": "file"}, {"name": "route.ts", "type": "file"}]}]}, {"name": "updates", "type": "dir", "children": [{"name": "route.ts", "type": "file"}]}]}, {"name": "app", "type": "dir", "children": [{"name": "api", "type": "dir", "children": [{"name": "debug", "type": "dir", "children": [{"name": "law", "type": "dir", "children": []}]}, {"name": "easy", "type": "dir", "children": [{"name": "import", "type": "dir", "children": []}]}, {"name": "law", "type": "dir", "children": [{"name": "[lawId]", "type": "dir", "children": []}, {"name": "route.ts.bak.1758259677", "type": "file"}, {"name": "route.ts.bak.1758261229", "type": "file"}, {"name": "route.ts.bak.1758261289", "type": "file"}]}]}, {"name": "contact", "type": "dir", "children": [{"name": "page.tsx", "type": "file"}]}, {"name": "easy", "type": "dir", "children": [{"name": "paste", "type": "dir", "children": [{"name": "page.tsx", "type": "file"}]}, {"name": "view", "type": "dir", "children": [{"name": "[lawId]", "type": "dir", "children": []}]}]}, {"name": "favicon.ico", "type": "dir", "children": [{"name": "route.ts", "type": "file"}]}, {"name": "law", "type": "dir", "children": [{"name": "[lawId]", "type": "dir", "children": [{"name": "loading.tsx", "type": "file"}, {"name": "page.backup.1757751382.tsx", "type": "file"}, {"name": "page.tsx", "type": "file"}, {"name": "page.tsx.bak", "type": "file"}, {"name": "page.tsx.bak.1757742410", "type": "file"}, {"name": "page.tsx.bak.1757742532", "type": "file"}, {"name": "page.tsx.bak.1757745036", "type": "file"}, {"name": "page.tsx.bak.1757745141", "type": "file"}, {"name": "page.tsx.bak.1757764821", "type": "file"}, {"name": "page.tsx.bak.1757767463", "type": "file"}, {"name": "page.tsx.bak.1757768786", "type": "file"}, {"name": "page.tsx.bak.1757769256", "type": "file"}, {"name": "page.tsx.bak.1757772031", "type": "file"}, {"name": "page.tsx.bak.1757772388", "type": "file"}, {"name": "page.tsx.bak.1757772433", "type": "file"}, {"name": "page.tsx.bak.1757772444", "type": "file"}, {"name": "page.tsx.bak.1757772705", "type": "file"}, {"name": "page.tsx.bak.1757912258", "type": "file"}, {"name": "page.tsx.bak.1757913992", "type": "file"}, {"name": "page.tsx.bak.1757914559", "type": "file"}, {"name": "page.tsx.bak.1757915222", "type": "file"}, {"name": "page.tsx.bak.1757915721", "type": "file"}, {"name": "page.tsx.bak.1757925580", "type": "file"}, {"name": "page.tsx.bak.1757926428", "type": "file"}, {"name": "page.tsx.bak.1757937307", "type": "file"}, {"name": "page.tsx.bak.1757980949", "type": "file"}, {"name": "page.tsx.bak.1757981167", "type": "file"}, {"name": "page.tsx.bak.1757981288", "type": "file"}, {"name": "page.tsx.bak.1757981364", "type": "file"}, {"name": "page.tsx.bak.1757981403", "type": "file"}, {"name": "page.tsx.bak.1757981435", "type": "file"}, {"name": "page.tsx.bak.1757981493", "type": "file"}, {"name": "page.tsx.bak.1757981643", "type": "file"}, {"name": "page.tsx.bak.1757981741", "type": "file"}, {"name": "page.tsx.bak.1757981893", "type": "file"}, {"name": "page.tsx.bak.1757981998", "type": "file"}, {"name": "page.tsx.bak.1757985142", "type": "file"}, {"name": "page.tsx.bak.1757986400", "type": "file"}, {"name": "page.tsx.bak.1757987351", "type": "file"}, {"name": "page.tsx.bak.1757987554", "type": "file"}, {"name": "page.tsx.bak.1757987878", "type": "file"}, {"name": "page.tsx.bak.1758259132", "type": "file"}, {"name": "page.tsx.bak.1758414703", "type": "file"}, {"name": "page.tsx.bak.1758415489", "type": "file"}, {"name": "page.tsx.bak.1758415594", "type": "file"}, {"name": "page.tsx.bak.1758416208", "type": "file"}, {"name": "page.tsx.bak.1758416337", "type": "file"}, {"name": "page.tsx.keep.1757913754", "type": "file"}]}, {"name": "test", "type": "dir", "children": [{"name": "page.tsx", "type": "file"}]}, {"name": "layout.tsx", "type": "file"}, {"name": "layout.tsx.bak.1758416850", "type": "file"}, {"name": "layout.tsx.bak.1758416938", "type": "file"}, {"name": "layout.tsx.bak.1758417057", "type": "file"}, {"name": "layout.tsx.bak.1758417241", "type": "file"}, {"name": "layout.tsx.bak.1758417373", "type": "file"}, {"name": "layout.tsx.bak.1758417647", "type": "file"}, {"name": "layout.tsx.bak.1758417725", "type": "file"}, {"name": "layout.tsx.bak.1758417810", "type": "file"}, {"name": "layout.tsx.bak.1758417816", "type": "file"}, {"name": "layout.tsx.bak.1758417911", "type": "file"}, {"name": "layout.tsx.bak.1758419098", "type": "file"}, {"name": "layout.tsx.bak.1758419784", "type": "file"}, {"name": "layout.tsx.bak.1758419969", "type": "file"}, {"name": "layout.tsx.bak.1758420152", "type": "file"}, {"name": "layout.tsx.bak.1758420487", "type": "file"}, {"name": "layout.tsx.bak.1758420648", "type": "file"}, {"name": "layout.tsx.bak.1758421510", "type": "file"}, {"name": "layout.tsx.bak.1758421864", "type": "file"}]}, {"name": "laws", "type": "dir", "children": [{"name": "[lawId]", "type": "dir", "children": [{"name": "page.tsx", "type": "file"}]}]}, {"name": "apple-icon.svg", "type": "file"}, {"name": "globals.css", "type": "file"}, {"name": "globals.css.bak.1757926875", "type": "file"}, {"name": "globals.css.bak.1757927137", "type": "file"}, {"name": "globals.css.bak.1757927505", "type": "file"}, {"name": "globals.css.bak.1758419484", "type": "file"}, {"name": "globals.css.bak.1758419974", "type": "file"}, {"name": "globals.css.bak.1758420487", "type": "file"}, {"name": "globals.css.bak.1758421012", "type": "file"}, {"name": "globals.css.bak.1758421172", "type": "file"}, {"name": "globals.css.bak.1758421515", "type": "file"}, {"name": "globals.css.bak.1758421868", "type": "file"}, {"name": "globals.css.bak.1758422433", "type": "file"}, {"name": "globals.css.bak.1758422810", "type": "file"}, {"name": "icon.svg", "type": "file"}, {"name": "layout.tsx", "type": "file"}, {"name": "layout.tsx.bak.1758419088", "type": "file"}, {"name": "layout.tsx.bak.1758419477", "type": "file"}, {"name": "layout.tsx.bak.1758420284", "type": "file"}, {"name": "layout.tsx.bak.1758420487", "type": "file"}, {"name": "layout.tsx.bak.1758420738", "type": "file"}, {"name": "layout.tsx.bak.1758420830", "type": "file"}, {"name": "layout.tsx.bak.1758421166", "type": "file"}, {"name": "layout.tsx.bak.1758421349", "type": "file"}, {"name": "layout.tsx.bak.1758421503", "type": "file"}, {"name": "layout.tsx.bak.1758421859", "type": "file"}, {"name": "layout.tsx.bak.1758422433", "type": "file"}, {"name": "layout.tsx.bak.1758422810", "type": "file"}, {"name": "page.tsx", "type": "file"}]}, {"name": "backup_lib", "type": "dir", "children": [{"name": "parseLawXml.ts.2025-09-13-040626", "type": "file"}]}, {"name": "features", "type": "dir", "children": [{"name": "accessible-law", "type": "dir", "children": [{"name": "HeaderPortal.tsx", "type": "file"}, {"name": "LawContent.tsx", "type": "file"}, {"name": "LawContent.tsx.bak.1758328917", "type": "file"}, {"name": "LawContent.tsx.bak.1758329094", "type": "file"}, {"name": "LawContext.tsx", "type": "file"}, {"name": "LawContext.tsx.bak.1758416557", "type": "file"}]}]}, {"name": "lib", "type": "dir", "children": [{"name": "html", "type": "dir", "children": [{"name": "splitAppendix.ts", "type": "file"}]}, {"name": "law", "type": "dir", "children": [{"name": "loadLaw.ts.bak.1758259132", "type": "file"}, {"name": "loadLaw.ts.bak.1758259251", "type": "file"}]}, {"name": "egov.ts", "type": "file"}, {"name": "egov.ts.bak.1758257453", "type": "file"}, {"name": "egov.ts.bak.1758257647", "type": "file"}, {"name": "egov.ts.bak.1758267919", "type": "file"}, {"name": "egov.ts.bak.1758270945", "type": "file"}, {"name": "egov.ts.bak.1758328392", "type": "file"}, {"name": "egov.ts.bak.1758415369", "type": "file"}, {"name": "fetchLaw.ts", "type": "file"}, {"name": "parseLawXml.backup.1757751382.ts", "type": "file"}, {"name": "parseLawXml.ts", "type": "file"}, {"name": "parseLawXml.ts.bak", "type": "file"}, {"name": "parseLawXml.ts.bak.1757735844", "type": "file"}, {"name": "parseLawXml.ts.bak.1757741756", "type": "file"}, {"name": "parseLawXml.ts.bak.1757741879", "type": "file"}, {"name": "parseLawXml.ts.bak.1757742057", "type": "file"}, {"name": "parseLawXml.ts.bak.1757742270", "type": "file"}, {"name": "parseLawXml.ts.bak.1757985875", "type": "file"}, {"name": "parseLawXml.ts.bak.1757986800", "type": "file"}, {"name": "parseLawXml.ts.bak.1757987151", "type": "file"}, {"name": "rokupo.ts", "type": "file"}, {"name": "rokupo.ts.bak.1758415557", "type": "file"}]}, {"name": "public", "type": "dir", "children": [{"name": "easy", "type": "dir", "children": [{"name": "ConstitutionofJapan.json", "type": "file"}, {"name": "TEST.json", "type": "file"}, {"name": "TEST_MULTI.json", "type": "file"}]}, {"name": "tree.html", "type": "file"}]}, {"name": "scripts", "type": "dir", "children": [{"name": "fs_tree.py", "type": "file"}, {"name": "fs_tree_html.py", "type": "file"}]}, {"name": "utils", "type": "dir", "children": [{"name": "htmlFilters.ts", "type": "file"}, {"name": "htmlFilters.ts.bak.1757987768", "type": "file"}, {"name": "htmlFilters.ts.bak.1757988347", "type": "file"}, {"name": "htmlFilters.ts.bak.1757988464", "type": "file"}, {"name": "htmlFilters.ts.bak.1757988929", "type": "file"}, {"name": "lawFormat.ts", "type": "file"}, {"name": "lawFormat.ts.bak.1757772696", "type": "file"}, {"name": "lawFormat.ts.bak.1757984292", "type": "file"}, {"name": "lawFormat.ts.bak.1757984420", "type": "file"}, {"name": "lawFormat.ts.bak.1757984621", "type": "file"}, {"name": "lawFormat.ts.bak.1757984844", "type": "file"}]}, {"name": "Article[]", "type": "file"}, {"name": "et --hard a8f09e9", "type": "file"}, {"name": "law.json", "type": "file"}, {"name": "next-env.d.ts", "type": "file"}, {"name": "package-lock.json", "type": "file"}, {"name": "package.json", "type": "file"}, {"name": "postcss.config.js", "type": "file"}, {"name": "t_'", "type": "file"}, {"name": "tailwind.config.js", "type": "file"}, {"name": "tailwind.config.js.bak", "type": "file"}, {"name": "tsconfig.json", "type": "file"}, {"name": "tsconfig.tsbuildinfo", "type": "file"}, {"name": "}", "type": "file"}]};
  const ROOT_LABEL = DATA.name || "repo";

  const $tree = document.getElementById('tree');
  const $q = document.getElementById('q');
  const $stats = document.getElementById('stats');
  const $rootName = document.getElementById('rootName');
  $rootName.textContent = "Root: " + ROOT_LABEL;

  const $pName = document.getElementById('p_name');
  const $pRole = document.getElementById('p_role');
  const $pDesc = document.getElementById('p_desc');
  const $pPath = document.getElementById('p_path');
  const $pType = document.getElementById('p_type');
  const $pExt  = document.getElementById('p_ext');

  function icon(node){
    if(node.type === 'dir') return "📁";
    const n = (node.name||"").toLowerCase();
    if(n.endsWith('.md')) return "��";
    if(n.endsWith('.ts')||n.endsWith('.tsx')||n.endsWith('.js')||n.endsWith('.jsx')) return "🧩";
    if(n.endsWith('.json')) return "🧾";
    if(n.endsWith('.png')||n.endsWith('.jpg')||n.endsWith('.jpeg')||n.endsWith('.svg')||n.endsWith('.gif')) return "🖼️";
    if(n.endsWith('.pdf')) return "📄";
    return "📄";
  }

  // ===== Next.js App Router 向け 役割判定 =====
  function roleInfo(path, isDir){
    const p = path.replace(/\\/g,'/'); // normalize
    const name = p.split('/').pop() || '';
    const ext = (name.includes('.') ? name.split('.').pop() : '').toLowerCase();

    // 1) ディレクトリ/ルート系
    if(isDir){
      if(p === 'app' || p.startsWith('app/')) return ['App Router ルート', 'Next.js App Router のルーティング・UIツリー。各セグメント配下に page/layout/error などを配置。'];
      if(p === 'public' || p.startsWith('public/')) return ['静的アセット', 'そのまま配信される公開ファイル置き場。/favicon.ico など。'];
      if(p.startsWith('app/api/')) return ['API ルート群', 'App Router の Route Handlers をまとめたディレクトリ。HTTP エンドポイントを提供。'];
      if(p === 'components' || p.startsWith('components/')) return ['UI コンポーネント', '再利用可能な表示部品置き場。'];
      if(p === 'lib' || p.startsWith('lib/')) return ['ライブラリ/ユーティリティ', 'ビジネスロジックやユーティリティ関数等。'];
      return ['ディレクトリ', ''];
    }

    // 2) app セグメントの特別ファイル
    if(/^app\/.*\/page\.(tsx|jsx|js|ts)$/.test(p) || p === 'app/page.tsx' || p === 'app/page.jsx'){
      return ['ページ（Route）', 'URL に直接対応するページコンポーネント。'];
    }
    if(/^app\/.*\/layout\.(tsx|jsx|js|ts)$/.test(p) || p === 'app/layout.tsx' || p === 'app/layout.jsx'){
      return ['レイアウト', 'セグメント配下の共通 UI。children を含む。'];
    }
    if(/^app\/.*\/template\.(tsx|jsx|js|ts)$/.test(p)){
      return ['テンプレート', 'マウント毎に再生成されるレイアウト相当の UI。'];
    }
    if(/^app\/.*\/loading\.(tsx|jsx|js|ts)$/.test(p)){
      return ['ローディング UI', '遅延時に表示するローディング用コンポーネント。'];
    }
    if(/^app\/.*\/error\.(tsx|jsx|js|ts)$/.test(p)){
      return ['エラー UI', 'セグメント配下のエラー境界。'];
    }
    if(/^app\/.*\/not-found\.(tsx|jsx|js|ts)$/.test(p)){
      return ['404 UI', 'そのセグメントの 404 表示。'];
    }
    if(/^app\/.*\/default\.(tsx|jsx|js|ts)$/.test(p)){
      return ['Parallel Routes 既定', 'パラレルルートの未選択スロット表示。'];
    }
    if(/^app\/.*\/route\.(ts|js)$/.test(p)){
      return ['Route Handler(API)', 'HTTP メソッドごとのハンドラを定義する API ルート。'];
    }
    if(/^middleware\.(ts|js)$/.test(name)){
      return ['Middleware', 'リクエスト前処理（国際化・認可など）。'];
    }

    // 3) 設定・構成ファイル
    if(name === 'next.config.js' || name === 'next.config.ts'){
      return ['Next.js 設定', 'Next.js 全体の設定。'];
    }
    if(name === 'tailwind.config.js' || name === 'tailwind.config.ts'){
      return ['Tailwind 設定', 'Tailwind CSS の設定。'];
    }
    if(name === 'postcss.config.js' || name === 'postcss.config.cjs'){
      return ['PostCSS 設定', 'PostCSS の設定。'];
    }
    if(name === 'tsconfig.json'){
      return ['TypeScript 設定', 'TypeScript コンパイラ設定。'];
    }
    if(name === 'package.json'){
      return ['パッケージ定義', '依存関係・スクリプト・メタ情報。'];
    }
    if(name === 'globals.css'){
      return ['グローバル CSS', 'アプリ全体のスタイル。'];
    }
    if(/^robots\.txt$/.test(name)){
      return ['robots.txt', 'クローラ向けのクロール制御。'];
    }
    if(/^sitemap\.xml$/.test(name)){
      return ['サイトマップ', '検索エンジン向け URL 一覧。'];
    }
    if(/^icon\.(png|ico|svg)$/.test(name) || name === 'favicon.ico'){
      return ['サイトアイコン', 'ブラウザや PWA 用のアイコン。'];
    }

    // 4) よくある配置
    if(p.startsWith('components/') && /\.(tsx|jsx|ts|js)$/.test(name)){
      return ['UI コンポーネント', '再利用可能なコンポーネント。'];
    }
    if(p.startsWith('lib/') && /\.(ts|js)$/.test(name)){
      return ['ユーティリティ/ロジック', '関数群やサービス層の実装。'];
    }
    if(p.startsWith('public/')){
      return ['静的アセット', 'そのまま配信されるファイル。'];
    }

    // 5) 拡張子ベースの汎用
    if(['ts','tsx','js','jsx'].includes(ext)) return ['ソースコード', ''];
    if(['css','scss'].includes(ext)) return ['スタイル', ''];
    if(['md','mdx'].includes(ext)) return ['ドキュメント', ''];
    if(['json'].includes(ext)) return ['設定/データ(JSON)', ''];
    return ['ファイル', ''];
  }

  function build(node, basePath){
    // basePath: 親までの相対パス
    if(node.type === 'dir'){
      const det = document.createElement('details');
      const sum = document.createElement('summary');
      const path = basePath ? (basePath + '/' + node.name) : node.name;
      sum.innerHTML = '<span class="node dir clickable"><span>'+icon(node)+'</span><span class="label">'+escapeHtml(node.name)+'/</span><span class="muted">'+(node.children?.length||0)+'項目</span></span>';
      sum.dataset.path = path;
      sum.onclick = (e)=>{ e.stopPropagation(); select(path, true); };
      det.appendChild(sum);
      const ul = document.createElement('ul');
      (node.children||[]).sort((a,b)=>{
        const da = (a.type==='dir')?0:1, db = (b.type==='dir')?0:1;
        if(da!==db) return da-db;
        return a.name.localeCompare(b.name, 'ja');
      }).forEach(ch=>{
        ul.appendChild(buildItem(ch, path));
      });
      det.appendChild(ul);
      return det;
    } else {
      return buildItem(node, basePath);
    }
  }

  function buildItem(node, basePath){
    const path = basePath ? (basePath + '/' + node.name) : node.name;
    if(node.type === 'dir'){
      const li = document.createElement('li');
      const det = build(node, path);
      li.appendChild(det);
      return li;
    }
    const li = document.createElement('li');
    li.className = 'file';
    const span = document.createElement('span');
    span.className = 'node clickable';
    span.dataset.path = path;
    span.onclick = (e)=>{ e.stopPropagation(); select(path, false, li); };
    span.innerHTML = '<span>'+icon(node)+'</span><span class="label">'+escapeHtml(node.name)+'</span>'+extBadge(node.name);
    li.appendChild(span);
    return li;
  }

  function extBadge(name){
    const idx = name.lastIndexOf('.');
    if(idx<=0) return '';
    const ext = name.slice(idx+1);
    return ' <span class="ext">.'+escapeHtml(ext)+'</span>';
  }

  function escapeHtml(s){
    return s.replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
  }

  function render(){
    $tree.innerHTML = '';
    $tree.appendChild(build(DATA, ''));
    $stats.textContent = countStats(DATA);
  }

  function countStats(node){
    let files=0, dirs=0;
    function walk(n){
      if(n.type==='dir'){
        dirs++;
        (n.children||[]).forEach(walk);
      } else files++;
    }
    walk(node);
    return `dirs: ${dirs-1}, files: ${files}`;
  }

  function match(glob, text){
    if(!glob) return true;
    glob = glob.toLowerCase();
    text = text.toLowerCase();
    const parts = glob.split('*');
    let pos = 0;
    for(const p of parts){
      if(!p) continue;
      const i = text.indexOf(p, pos);
      if(i<0) return false;
      pos = i + p.length;
    }
    return true;
  }

  function filterTree(q){
    const glob = q.trim();
    let hits = 0;

    function recurse(el){
      if(el.tagName==='DETAILS'){
        const sum = el.querySelector(':scope > summary .label');
        const name = sum?.textContent || '';
        const ul = el.querySelector(':scope > ul');
        let childHit = 0;
        ul.querySelectorAll(':scope > li').forEach(li=>{
          const h = recurse(li);
          childHit += h;
          li.style.display = h ? '' : 'none';
        });
        const selfHit = match(glob, name);
        const hit = selfHit || childHit>0;
        sum?.classList.toggle('hit', selfHit && glob);
        el.style.display = hit ? '' : 'none';
        el.open = hit && glob ? true : el.open;
        hits += hit ? 1 : 0;
        return hit ? 1 : 0;
      } else if(el.tagName==='LI'){
        const lab = el.querySelector(':scope .label');
        const name = lab?.textContent || '';
        const isHit = match(glob, name);
        lab?.classList.toggle('hit', isHit && glob);
        hits += isHit ? 1 : 0;
        return isHit ? 1 : 0;
      }
      return 0;
    }

    const top = $tree.firstElementChild;
    if(!top) return;
    recurse(top);
    $stats.textContent = countStats(DATA) + (glob ? ` | hits: ${hits}` : '');
  }

  // 選択して右ペインへ反映
  let lastSel;
  function select(path, isDir, liElem){
    if(lastSel) lastSel.classList.remove('selected');
    if(liElem) { liElem.classList.add('selected'); lastSel = liElem; }
    const name = path.split('/').pop() || path;
    const ext = (name.includes('.') ? name.split('.').pop() : '');
    const [role, desc] = roleInfo(path, isDir);
    $pName.textContent = name;
    $pRole.textContent = role || '';
    $pDesc.textContent = desc || '';
    $pPath.textContent = path;
    $pType.textContent = isDir ? 'directory' : 'file';
    $pExt.textContent = isDir ? '-' : (ext || '(none)');
  }

  // 初期描画
  render();

  // コントロール
  document.getElementById('expand').onclick = ()=> {
    $tree.querySelectorAll('details').forEach(d=>d.open = true);
  };
  document.getElementById('collapse').onclick = ()=> {
    $tree.querySelectorAll('details').forEach(d=>d.open = false);
  };
  let t=null;
  $q.addEventListener('input', ()=>{
    clearTimeout(t); t=setTimeout(()=>filterTree($q.value), 120);
  });
</script>
</body>
</html>
